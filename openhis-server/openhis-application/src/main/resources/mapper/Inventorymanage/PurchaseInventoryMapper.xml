<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.openhis.web.inventorymanage.mapper.PurchaseInventoryMapper">

    <select id="selectInventoryReceiptPage"
            resultType="com.openhis.web.inventorymanage.dto.InventoryReceiptPageDto">
        SELECT T2.id,
               T2.bus_no AS supply_bus_no,
               T2.status_enum,
               T2.supplier_id,
               T2.approver_id,
               T2.approval_time,
               T2.applicant_id,
               T2.apply_time,
               T2.practitioner_id,
               T2.tenant_id
        FROM (SELECT T1.id,
                     T1.bus_no,
                     T1.status_enum,
                     T1.supplier_id,
                     T1.approver_id,
                     T1.approval_time,
                     T1.applicant_id,
                     T1.apply_time,
                     T1.practitioner_id,
                     T1.tenant_id
              FROM wor_supply_request AS T1
              WHERE type_enum = #{purchaseInventory}
              GROUP BY T1.id,
                       T1.bus_no,
                       T1.status_enum,
                       T1.supplier_id,
                       T1.approver_id,
                       T1.approval_time,
                       T1.applicant_id,
                       T1.apply_time,
                       T1.practitioner_id,
                       T1.tenant_id
              ORDER BY T1.bus_no desc
            ) AS T2
        ${ew.customSqlSegment}
    </select>
    <select id="selectDetail" resultType="com.openhis.web.inventorymanage.dto.ReceiptDetailDto">
        SELECT *
        FROM wor_supply_request T1
            LEFT JOIN med_medication_definition T2
                ON T1.item_id = T2.id
            LEFT JOIN med_medication T3
                ON T3.medication_def_id = T2.id
            LEFT JOIN adm_supplier T4
                ON T4.id = T1.supplier_id
            LEFT JOIN adm_practitioner T5
                ON T1.practitioner_id = T5.id
            LEFT JOIN adm_location T6
                ON T1.purpose_location_id = T6.id
            LEFT JOIN adm_location T7
                ON T1.purpose_location_store_id  = T7.id
        WHERE T1.bus_no = #{busNo}
            AND T1.delete_flag = '0'
        UNION ALL
        SELECT *
        FROM wor_supply_request T1
            LEFT JOIN adm_device_definition T8
                ON T1.item_id = T8.id
            LEFT JOIN adm_supplier T4
                ON T4.id = T1.supplier_id
            LEFT JOIN adm_practitioner T5
                ON T1.practitioner_id = T5.id
            LEFT JOIN adm_location T6
                ON T1.purpose_location_id = T6.id
            LEFT JOIN adm_location T7
                ON T1.purpose_location_store_id  = T7.id
        WHERE T1.bus_no = #{busNo}
            AND T1.delete_flag = '0'
    </select>
</mapper>